<svg xmlns="http://www.w3.org/2000/svg" width="900" height="620" viewBox="0 0 900 620">
  <rect width="900" height="620" fill="white"/>

  <text x="450" y="38" font-family="monospace" font-size="18" font-weight="bold"
        text-anchor="middle" dominant-baseline="middle" fill="#2c3e50">
    YTM Solver State Machine: Newton-Raphson + Bisection Fallback
  </text>

  <!-- State circles: radius 52 -->
  <!-- INIT -->
  <circle cx="130" cy="160" r="52" fill="#eaf6fb" stroke="#3498db" stroke-width="2.5"/>
  <text x="130" y="153" font-family="monospace" font-size="13" font-weight="bold"
        text-anchor="middle" dominant-baseline="middle" fill="#2980b9">INIT</text>
  <text x="130" y="171" font-family="monospace" font-size="9"
        text-anchor="middle" dominant-baseline="middle" fill="#555">compute initial</text>
  <text x="130" y="183" font-family="monospace" font-size="9"
        text-anchor="middle" dominant-baseline="middle" fill="#555">guess from YTM</text>
  <text x="130" y="195" font-family="monospace" font-size="9"
        text-anchor="middle" dominant-baseline="middle" fill="#555">approximation</text>

  <!-- Arrow INIT → BRACKET -->
  <line x1="182" y1="160" x2="248" y2="160" stroke="#3498db" stroke-width="2" marker-end="url(#sm1)"/>

  <!-- BRACKET -->
  <circle cx="310" cy="160" r="52" fill="#eafaf1" stroke="#2ecc71" stroke-width="2.5"/>
  <text x="310" y="148" font-family="monospace" font-size="13" font-weight="bold"
        text-anchor="middle" dominant-baseline="middle" fill="#27ae60">BRACKET</text>
  <text x="310" y="166" font-family="monospace" font-size="9"
        text-anchor="middle" dominant-baseline="middle" fill="#555">Find [r_low, r_high]</text>
  <text x="310" y="180" font-family="monospace" font-size="9"
        text-anchor="middle" dominant-baseline="middle" fill="#555">where P(r_low) &gt; target</text>
  <text x="310" y="194" font-family="monospace" font-size="9"
        text-anchor="middle" dominant-baseline="middle" fill="#555">&gt; P(r_high)</text>

  <!-- Arrow BRACKET → FAIL_BRACKET (downward) -->
  <line x1="310" y1="212" x2="310" y2="278" stroke="#e74c3c" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#sm_red)"/>
  <text x="345" y="245" font-family="monospace" font-size="9" fill="#e74c3c">no bracket found</text>

  <!-- BRACKET_FAIL -->
  <rect x="240" y="280" width="140" height="60" rx="10" fill="#fdedec" stroke="#e74c3c" stroke-width="2"/>
  <text x="310" y="303" font-family="monospace" font-size="12" font-weight="bold"
        text-anchor="middle" dominant-baseline="middle" fill="#c0392b">FAIL</text>
  <text x="310" y="322" font-family="monospace" font-size="9"
        text-anchor="middle" dominant-baseline="middle" fill="#c0392b">ValueError: cannot bracket</text>
  <text x="310" y="335" font-family="monospace" font-size="9"
        text-anchor="middle" dominant-baseline="middle" fill="#888">log + re-raise</text>

  <!-- Arrow BRACKET → NEWTON -->
  <line x1="362" y1="155" x2="478" y2="155" stroke="#2ecc71" stroke-width="2" marker-end="url(#sm2)"/>
  <text x="420" y="142" font-family="monospace" font-size="9" fill="#27ae60">bracket OK</text>

  <!-- NEWTON-RAPHSON -->
  <circle cx="545" cy="155" r="60" fill="#fef9e7" stroke="#e67e22" stroke-width="2.5"/>
  <text x="545" y="135" font-family="monospace" font-size="12" font-weight="bold"
        text-anchor="middle" dominant-baseline="middle" fill="#d35400">NEWTON</text>
  <text x="545" y="153" font-family="monospace" font-size="12" font-weight="bold"
        text-anchor="middle" dominant-baseline="middle" fill="#d35400">RAPHSON</text>
  <text x="545" y="170" font-family="monospace" font-size="9"
        text-anchor="middle" dominant-baseline="middle" fill="#555">r = r - err/dp_dr</text>
  <text x="545" y="184" font-family="monospace" font-size="9"
        text-anchor="middle" dominant-baseline="middle" fill="#555">update bracket</text>

  <!-- Self-loop on NR (iterate) -->
  <path d="M 570 95 Q 630 60 605 95" fill="none" stroke="#e67e22" stroke-width="1.5"
        stroke-dasharray="4,2" marker-end="url(#sm3)"/>
  <text x="635" y="75" font-family="monospace" font-size="9" fill="#e67e22">|err| &gt; tol</text>
  <text x="635" y="87" font-family="monospace" font-size="9" fill="#e67e22">iterate</text>

  <!-- Arrow NR → BISECT (when step too large or flat derivative) -->
  <line x1="545" y1="215" x2="545" y2="278" stroke="#9b59b6" stroke-width="1.5"
        stroke-dasharray="5,3" marker-end="url(#sm4)"/>
  <text x="558" y="248" font-family="monospace" font-size="9" fill="#9b59b6">|step|&gt;0.5</text>
  <text x="558" y="260" font-family="monospace" font-size="9" fill="#9b59b6">or flat deriv.</text>

  <!-- BISECTION fallback -->
  <circle cx="545" cy="350" r="52" fill="#fef5fb" stroke="#9b59b6" stroke-width="2.5"/>
  <text x="545" y="338" font-family="monospace" font-size="12" font-weight="bold"
        text-anchor="middle" dominant-baseline="middle" fill="#8e44ad">BISECT</text>
  <text x="545" y="356" font-family="monospace" font-size="9"
        text-anchor="middle" dominant-baseline="middle" fill="#555">r = (r_low + r_high) / 2</text>
  <text x="545" y="370" font-family="monospace" font-size="9"
        text-anchor="middle" dominant-baseline="middle" fill="#555">tighten bracket</text>

  <!-- Arrow BISECT → NR (resume) -->
  <path d="M 593 340 Q 680 250 605 200" fill="none" stroke="#9b59b6" stroke-width="1.5"
        marker-end="url(#sm4)"/>
  <text x="695" y="280" font-family="monospace" font-size="9" fill="#9b59b6">resume NR</text>

  <!-- Arrow NR → CONVERGED -->
  <line x1="605" y1="148" x2="718" y2="148" stroke="#2ecc71" stroke-width="2" marker-end="url(#sm2)"/>
  <text x="660" y="135" font-family="monospace" font-size="9" fill="#27ae60">|err| ≤ tol</text>

  <!-- CONVERGED -->
  <circle cx="790" cy="148" r="52" fill="#eafaf1" stroke="#2ecc71" stroke-width="3"/>
  <text x="790" y="136" font-family="monospace" font-size="13" font-weight="bold"
        text-anchor="middle" dominant-baseline="middle" fill="#27ae60">CONVERGED</text>
  <text x="790" y="154" font-family="monospace" font-size="9"
        text-anchor="middle" dominant-baseline="middle" fill="#555">return ytm</text>
  <text x="790" y="168" font-family="monospace" font-size="9"
        text-anchor="middle" dominant-baseline="middle" fill="#555">|error| &lt; 1e-8</text>

  <!-- Arrow NR → MAX_ITER_FAIL -->
  <line x1="545" y1="402" x2="545" y2="468" stroke="#e74c3c" stroke-width="1.5"
        stroke-dasharray="5,3" marker-end="url(#sm_red)"/>
  <text x="558" y="436" font-family="monospace" font-size="9" fill="#e74c3c">iter &gt; max_iter</text>

  <!-- MAX ITER FAIL -->
  <rect x="455" y="470" width="180" height="60" rx="10" fill="#fdedec" stroke="#e74c3c" stroke-width="2"/>
  <text x="545" y="492" font-family="monospace" font-size="12" font-weight="bold"
        text-anchor="middle" dominant-baseline="middle" fill="#c0392b">FAIL</text>
  <text x="545" y="510" font-family="monospace" font-size="9"
        text-anchor="middle" dominant-baseline="middle" fill="#c0392b">RuntimeError: non-convergence</text>
  <text x="545" y="523" font-family="monospace" font-size="9"
        text-anchor="middle" dominant-baseline="middle" fill="#888">log final error + raise</text>

  <!-- Legend -->
  <rect x="50" y="480" width="300" height="110" rx="8" fill="#f8f9fa" stroke="#dee2e6" stroke-width="1"/>
  <text x="200" y="500" font-family="monospace" font-size="11" font-weight="bold"
        text-anchor="middle" dominant-baseline="middle" fill="#2c3e50">Legend</text>
  <line x1="70" y1="520" x2="120" y2="520" stroke="#2ecc71" stroke-width="2" marker-end="url(#sm2)"/>
  <text x="200" y="520" font-family="monospace" font-size="9"
        text-anchor="middle" dominant-baseline="middle" fill="#444">Happy path (convergence)</text>
  <line x1="70" y1="545" x2="120" y2="545" stroke="#e74c3c" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#sm_red)"/>
  <text x="200" y="545" font-family="monospace" font-size="9"
        text-anchor="middle" dominant-baseline="middle" fill="#444">Error paths</text>
  <line x1="70" y1="568" x2="120" y2="568" stroke="#9b59b6" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#sm4)"/>
  <text x="200" y="568" font-family="monospace" font-size="9"
        text-anchor="middle" dominant-baseline="middle" fill="#444">NR fallback to bisection</text>

  <!-- Markers -->
  <defs>
    <marker id="sm1" markerWidth="8" markerHeight="6" refX="6" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#3498db"/>
    </marker>
    <marker id="sm2" markerWidth="8" markerHeight="6" refX="6" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#2ecc71"/>
    </marker>
    <marker id="sm3" markerWidth="8" markerHeight="6" refX="6" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#e67e22"/>
    </marker>
    <marker id="sm4" markerWidth="8" markerHeight="6" refX="6" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#9b59b6"/>
    </marker>
    <marker id="sm_red" markerWidth="8" markerHeight="6" refX="6" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#e74c3c"/>
    </marker>
  </defs>
</svg>
